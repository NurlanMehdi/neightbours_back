<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Private Chat WebSocket Test - Browser Client</title>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .clients-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .client-box {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .client-header h2 {
      color: #333;
      font-size: 20px;
    }

    .status {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status.disconnected {
      background: #fee;
      color: #c00;
    }

    .status.connected {
      background: #efe;
      color: #0a0;
    }

    .config-section {
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #555;
      margin-bottom: 5px;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-secondary {
      background: #718096;
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .messages-section {
      margin-top: 20px;
    }

    .messages-header {
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 10px;
    }

    .messages-box {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .message {
      background: white;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 8px;
      border-left: 3px solid #667eea;
      font-size: 13px;
      line-height: 1.5;
    }

    .message.sent {
      border-left-color: #48bb78;
    }

    .message.received {
      border-left-color: #ed8936;
    }

    .message.system {
      border-left-color: #718096;
      background: #f0f0f0;
    }

    .message-time {
      font-size: 11px;
      color: #999;
      margin-right: 8px;
    }

    .message-type {
      font-weight: 600;
      margin-right: 8px;
      font-size: 11px;
    }

    .message-content {
      color: #333;
    }

    .instructions {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      color: #856404;
    }

    .instructions h3 {
      margin-bottom: 10px;
      color: #856404;
    }

    .instructions ol {
      margin-left: 20px;
    }

    .instructions li {
      margin-bottom: 5px;
    }

    .test-results {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .test-results h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .test-item {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 5px;
      font-size: 14px;
    }

    .test-item.pass {
      background: #e6ffed;
      color: #0a5e0a;
    }

    .test-item.fail {
      background: #ffe6e6;
      color: #c00;
    }

    .test-item.pending {
      background: #f0f0f0;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß™ Private Chat WebSocket Test - Browser Client</h1>
      <p>Test the refactored Private Chat WebSocket system that requires no manual join events</p>
    </div>

    <div class="instructions">
      <h3>üìã Quick Instructions:</h3>
      <ol>
        <li>Get JWT tokens for two test users (via <code>POST /auth/login</code>)</li>
        <li>Paste tokens into User A and User B fields below</li>
        <li>Click "Connect" for both users</li>
        <li>Send a message from User A to User B</li>
        <li>Verify both users receive the message in real-time</li>
      </ol>
    </div>

    <div class="clients-container">
      <!-- User A -->
      <div class="client-box">
        <div class="client-header">
          <h2>üë§ User A</h2>
          <span class="status disconnected" id="statusA">Disconnected</span>
        </div>
        
        <div class="config-section">
          <div class="form-group">
            <label>Server URL:</label>
            <input type="text" id="serverUrlA" value="http://localhost:3000" />
          </div>
          <div class="form-group">
            <label>JWT Token:</label>
            <input type="text" id="tokenA" placeholder="Paste JWT token here..." />
          </div>
          <div class="form-group">
            <label>Your User ID:</label>
            <input type="number" id="userIdA" value="1" />
          </div>
          <div class="form-group">
            <label>Receiver User ID (User B):</label>
            <input type="number" id="receiverIdA" value="2" />
          </div>
          
          <button class="btn btn-primary" onclick="connectUserA()">Connect</button>
          <button class="btn btn-danger" onclick="disconnectUserA()" disabled id="disconnectBtnA">Disconnect</button>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label>Message to send:</label>
          <textarea id="messageTextA" placeholder="Type your message here...">Hello from User A!</textarea>
          <button class="btn btn-success" onclick="sendMessageA()" disabled id="sendBtnA" style="margin-top: 10px; width: 100%;">
            Send Message to User B
          </button>
        </div>

        <div class="messages-section">
          <div class="messages-header">üì® Messages & Events:</div>
          <div class="messages-box" id="messagesA"></div>
        </div>
      </div>

      <!-- User B -->
      <div class="client-box">
        <div class="client-header">
          <h2>üë§ User B</h2>
          <span class="status disconnected" id="statusB">Disconnected</span>
        </div>
        
        <div class="config-section">
          <div class="form-group">
            <label>Server URL:</label>
            <input type="text" id="serverUrlB" value="http://localhost:3000" />
          </div>
          <div class="form-group">
            <label>JWT Token:</label>
            <input type="text" id="tokenB" placeholder="Paste JWT token here..." />
          </div>
          <div class="form-group">
            <label>Your User ID:</label>
            <input type="number" id="userIdB" value="2" />
          </div>
          <div class="form-group">
            <label>Receiver User ID (User A):</label>
            <input type="number" id="receiverIdB" value="1" />
          </div>
          
          <button class="btn btn-primary" onclick="connectUserB()">Connect</button>
          <button class="btn btn-danger" onclick="disconnectUserB()" disabled id="disconnectBtnB">Disconnect</button>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label>Message to send:</label>
          <textarea id="messageTextB" placeholder="Type your message here...">Hello from User B!</textarea>
          <button class="btn btn-success" onclick="sendMessageB()" disabled id="sendBtnB" style="margin-top: 10px; width: 100%;">
            Send Message to User A
          </button>
        </div>

        <div class="messages-section">
          <div class="messages-header">üì® Messages & Events:</div>
          <div class="messages-box" id="messagesB"></div>
        </div>
      </div>
    </div>

    <div class="test-results">
      <h3>‚úÖ Test Results:</h3>
      <div id="testResults">
        <div class="test-item pending">‚è≥ Waiting for User A to connect...</div>
        <div class="test-item pending">‚è≥ Waiting for User B to connect...</div>
        <div class="test-item pending">‚è≥ Waiting for first message...</div>
      </div>
    </div>
  </div>

  <script>
    let socketA = null;
    let socketB = null;
    let testResults = {
      userAConnected: false,
      userBConnected: false,
      userAReceivedConnected: false,
      userBReceivedConnected: false,
      messageSent: false,
      senderReceivedMessage: false,
      receiverReceivedMessage: false
    };

    function logMessage(user, type, content) {
      const messagesBox = document.getElementById(`messages${user}`);
      const time = new Date().toLocaleTimeString();
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = `
        <span class="message-time">${time}</span>
        <span class="message-type">[${type.toUpperCase()}]</span>
        <span class="message-content">${content}</span>
      `;
      messagesBox.appendChild(messageDiv);
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    function updateStatus(user, connected) {
      const statusEl = document.getElementById(`status${user}`);
      statusEl.textContent = connected ? 'Connected' : 'Disconnected';
      statusEl.className = `status ${connected ? 'connected' : 'disconnected'}`;
      
      document.getElementById(`disconnectBtn${user}`).disabled = !connected;
      document.getElementById(`sendBtn${user}`).disabled = !connected;
    }

    function updateTestResults() {
      const results = [
        { test: 'User A connected', passed: testResults.userAConnected },
        { test: 'User B connected', passed: testResults.userBConnected },
        { test: 'User A received private:connected', passed: testResults.userAReceivedConnected },
        { test: 'User B received private:connected', passed: testResults.userBReceivedConnected },
        { test: 'Message sent successfully', passed: testResults.messageSent },
        { test: 'Sender received message (real-time)', passed: testResults.senderReceivedMessage },
        { test: 'Receiver received message (real-time) - CRITICAL', passed: testResults.receiverReceivedMessage }
      ];

      const resultsHtml = results.map(r => {
        const status = r.passed ? 'pass' : 'pending';
        const icon = r.passed ? '‚úÖ' : '‚è≥';
        return `<div class="test-item ${status}">${icon} ${r.test}</div>`;
      }).join('');

      document.getElementById('testResults').innerHTML = resultsHtml;
    }

    function connectUserA() {
      const serverUrl = document.getElementById('serverUrlA').value;
      const token = document.getElementById('tokenA').value;
      
      if (!token || token.trim() === '') {
        alert('Please enter a JWT token for User A');
        return;
      }

      logMessage('A', 'system', 'Connecting to server...');
      
      socketA = io(serverUrl, {
        transports: ['websocket'],
        query: { token: token },
        auth: { token: token }
      });

      socketA.on('connect', () => {
        logMessage('A', 'system', `Connected! Socket ID: ${socketA.id}`);
        updateStatus('A', true);
        testResults.userAConnected = true;
        updateTestResults();
      });

      socketA.on('connect_error', (error) => {
        logMessage('A', 'system', `Connection error: ${error.message}`);
        updateStatus('A', false);
      });

      socketA.on('disconnect', () => {
        logMessage('A', 'system', 'Disconnected from server');
        updateStatus('A', false);
      });

      socketA.on('private:connected', (data) => {
        logMessage('A', 'system', `Received private:connected: ${JSON.stringify(data)}`);
        testResults.userAReceivedConnected = true;
        updateTestResults();
      });

      socketA.on('private:message', (message) => {
        logMessage('A', 'received', `Message ID ${message.id}: "${message.text}" from user ${message.userId}`);
        
        const userId = parseInt(document.getElementById('userIdA').value);
        if (message.userId === userId) {
          testResults.senderReceivedMessage = true;
        } else {
          testResults.receiverReceivedMessage = true;
        }
        updateTestResults();
      });

      socketA.onAny((eventName, ...args) => {
        if (eventName !== 'private:connected' && eventName !== 'private:message') {
          logMessage('A', 'system', `Event ${eventName}: ${JSON.stringify(args)}`);
        }
      });
    }

    function disconnectUserA() {
      if (socketA) {
        socketA.disconnect();
        socketA = null;
        updateStatus('A', false);
      }
    }

    function sendMessageA() {
      if (!socketA || !socketA.connected) {
        alert('Please connect User A first');
        return;
      }

      const receiverId = parseInt(document.getElementById('receiverIdA').value);
      const text = document.getElementById('messageTextA').value;

      logMessage('A', 'sent', `Sending to user ${receiverId}: "${text}"`);

      socketA.emit('private:sendMessage', { receiverId, text }, (response) => {
        if (response && response.status === 'sent') {
          logMessage('A', 'system', `‚úÖ Message sent! ID: ${response.messageId}, Conversation: ${response.conversationId}`);
          testResults.messageSent = true;
          updateTestResults();
        } else {
          logMessage('A', 'system', `‚ùå Send failed: ${JSON.stringify(response)}`);
        }
      });
    }

    function connectUserB() {
      const serverUrl = document.getElementById('serverUrlB').value;
      const token = document.getElementById('tokenB').value;
      
      if (!token || token.trim() === '') {
        alert('Please enter a JWT token for User B');
        return;
      }

      logMessage('B', 'system', 'Connecting to server...');
      
      socketB = io(serverUrl, {
        transports: ['websocket'],
        query: { token: token },
        auth: { token: token }
      });

      socketB.on('connect', () => {
        logMessage('B', 'system', `Connected! Socket ID: ${socketB.id}`);
        updateStatus('B', true);
        testResults.userBConnected = true;
        updateTestResults();
      });

      socketB.on('connect_error', (error) => {
        logMessage('B', 'system', `Connection error: ${error.message}`);
        updateStatus('B', false);
      });

      socketB.on('disconnect', () => {
        logMessage('B', 'system', 'Disconnected from server');
        updateStatus('B', false);
      });

      socketB.on('private:connected', (data) => {
        logMessage('B', 'system', `Received private:connected: ${JSON.stringify(data)}`);
        testResults.userBReceivedConnected = true;
        updateTestResults();
      });

      socketB.on('private:message', (message) => {
        logMessage('B', 'received', `Message ID ${message.id}: "${message.text}" from user ${message.userId}`);
        
        const userId = parseInt(document.getElementById('userIdB').value);
        if (message.userId === userId) {
          testResults.senderReceivedMessage = true;
        } else {
          testResults.receiverReceivedMessage = true;
        }
        updateTestResults();
      });

      socketB.onAny((eventName, ...args) => {
        if (eventName !== 'private:connected' && eventName !== 'private:message') {
          logMessage('B', 'system', `Event ${eventName}: ${JSON.stringify(args)}`);
        }
      });
    }

    function disconnectUserB() {
      if (socketB) {
        socketB.disconnect();
        socketB = null;
        updateStatus('B', false);
      }
    }

    function sendMessageB() {
      if (!socketB || !socketB.connected) {
        alert('Please connect User B first');
        return;
      }

      const receiverId = parseInt(document.getElementById('receiverIdB').value);
      const text = document.getElementById('messageTextB').value;

      logMessage('B', 'sent', `Sending to user ${receiverId}: "${text}"`);

      socketB.emit('private:sendMessage', { receiverId, text }, (response) => {
        if (response && response.status === 'sent') {
          logMessage('B', 'system', `‚úÖ Message sent! ID: ${response.messageId}, Conversation: ${response.conversationId}`);
          testResults.messageSent = true;
          updateTestResults();
        } else {
          logMessage('B', 'system', `‚ùå Send failed: ${JSON.stringify(response)}`);
        }
      });
    }

    // Allow Enter key to send message
    document.getElementById('messageTextA').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessageA();
      }
    });

    document.getElementById('messageTextB').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessageB();
      }
    });
  </script>
</body>
</html>

