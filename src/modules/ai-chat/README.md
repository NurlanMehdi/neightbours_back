# AI Chat Module

Модуль для интеграции с OpenRouter AI API в приложении соседского сообщества.

## Описание

Каждый пользователь может иметь только один чат с AI ассистентом. Все сообщения сохраняются в базе данных и доступны через API. Интеграция использует **OpenRouter API** с моделью `deepseek/deepseek-chat-v3-0324:free`.

## Функциональность

- **Отправка сообщений**: Пользователи могут отправлять сообщения AI ассистенту
- **История чата**: Получение истории сообщений с пагинацией
- **Контекст**: AI ассистент учитывает предыдущие сообщения для более релевантных ответов
- **Настройки**: Возможность настройки температуры и максимального количества токенов
- **Мониторинг**: Проверка состояния OpenRouter API
- **Системный промпт**: Настроенный промпт для контекста соседского сообщества

## API Endpoints

### Основные эндпоинты

- `POST /api/ai-chat/send` - Отправить сообщение AI ассистенту
- `GET /api/ai-chat/history` - Получить историю чата с пагинацией
- `GET /api/ai-chat/chat` - Получить или создать чат пользователя
- `DELETE /api/ai-chat/clear` - Очистить историю чата

### Служебные эндпоинты

- `GET /api/ai-chat/health` - Проверить состояние AI сервиса
- `GET /api/ai-chat/info` - Получить информацию о конфигурации AI API

## Структура базы данных

### Таблица `ai_chats`
- `id` - Уникальный идентификатор чата
- `userId` - ID пользователя (уникальный)
- `createdAt` - Дата создания чата
- `updatedAt` - Дата последнего обновления

### Таблица `ai_chat_messages`
- `id` - Уникальный идентификатор сообщения
- `chatId` - ID чата
- `userId` - ID пользователя
- `role` - Роль отправителя (USER/ASSISTANT)
- `content` - Содержание сообщения
- `createdAt` - Дата создания сообщения

## Конфигурация

### Переменные окружения

```env
AI_API_URL=https://openrouter.ai/api/v1
AI_API_KEY=your-openrouter-api-key
```

### Пример .env файла

```bash
AI_API_URL=http://62.113.36.167:3000
AI_API_KEY=88d59d27272af9dd58a9b303a205624a02639b14f3bc45eb2297fbb4e268340e
```

## Внешний AI API

Модуль интегрируется с внешним AI API на базе Saiga Mistral 7B:

- **Базовый URL**: `http://62.113.36.167:3000`
- **Эндпоинт чата**: `/llama/chat`
- **Авторизация**: Заголовок `X-API-Key`

### Параметры запроса

```json
{
  "message": "Привет! Как дела?",
  "temperature": 0.7,
  "maxTokens": 1000,
  "systemPrompt": "Ты полезный помощник для приложения соседского сообщества..."
}
```

## Использование

### Отправка сообщения

```bash
curl -X POST http://localhost:3000/api/ai-chat/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-jwt-token" \
  -d '{
    "message": "Привет! Как дела?",
    "temperature": 0.7,
    "maxTokens": 1000
  }'
```

### Получение истории

```bash
curl -X GET "http://localhost:3000/api/ai-chat/history?page=1&limit=50" \
  -H "Authorization: Bearer your-jwt-token"
```

## Особенности реализации

1. **Один чат на пользователя**: Каждый пользователь может иметь только один чат
2. **Автоматическое создание**: Чат создается автоматически при первом сообщении
3. **Контекст**: AI ассистент получает последние 10 сообщений для контекста
4. **Системный промпт**: Настроен специально для приложения соседского сообщества
5. **Обработка ошибок**: Полная обработка ошибок внешнего API
6. **Таймауты**: Настроены таймауты для HTTP запросов (60 секунд)

## Миграция базы данных

Для применения изменений в базе данных выполните:

```bash
npx prisma migrate dev --name add-ai-chat
```

## Безопасность

- Все эндпоинты защищены JWT авторизацией
- Пользователи могут видеть только свои чаты
- API ключ для внешнего сервиса хранится в переменных окружения
- Валидация всех входящих данных

## Мониторинг

Доступны эндпоинты для мониторинга состояния AI сервиса:

- `/api/ai-chat/health` - Быстрая проверка доступности
- `/api/ai-chat/info` - Подробная информация о конфигурации 